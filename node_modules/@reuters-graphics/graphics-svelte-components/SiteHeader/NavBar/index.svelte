<script>
  import DownArrow from './DownArrow.svelte';
  import SectionDrowdown from './NavDropdown/SectionDrowdown.svelte';
  import MoreDropdown from './NavDropdown/MoreDropdown.svelte';
  import { normalizeUrl } from './utils/index';
  import { getContext } from 'svelte';

  export let sections = [];

  const activeSection = getContext('nav-active-section');

  let windowWidth = 1200;

  $: getDisplayCount = () => {
    if (windowWidth >= 1300) return 7;
    return 5;
  };

  let navTimeout;
  const timeout = 250;

  $: displayCount = getDisplayCount();
  $: displaySections = sections.slice(0, displayCount);
  $: hiddenSections = sections.slice(displayCount);
</script>

<svelte:window bind:innerWidth="{windowWidth}" />

<div class="nav-bar">
  <nav aria-label="Main navigation">
    <ul class="nav-list">
      {#each displaySections as section}
        {#if section.children}
          <li
            class="nav-item category link"
            on:mouseenter="{() => {
              navTimeout = setTimeout(
                () => activeSection.set(section.id),
                timeout
              );
            }}"
            on:focus="{() => activeSection.set(section.id)}"
            on:mouseleave="{() => {
              clearTimeout(navTimeout);
              activeSection.set(null);
            }}"
            on:blur="{() => {
              clearTimeout(navTimeout);
              activeSection.set(null);
            }}"
            on:click="{() => {
              if ($activeSection === section.id) {
                clearTimeout(navTimeout);
                activeSection.set(null);
              }
            }}"
          >
            <div
              class="nav-button link"
              class:open="{section.id === $activeSection}"
            >
              <a href="{normalizeUrl(section.url)}">
                {section.name}
              </a>
              <button class="button">
                <DownArrow rotate="{section.id === $activeSection}" />
              </button>
            </div>
            {#if $activeSection === section.id}
              <SectionDrowdown
                section="{section}"
                headingText="{`Latest in ${section.name}`}"
              />
            {/if}
          </li>
        {:else}
          <li class="nav-item category link">
            <div class="nav-button link">
              <a href="{normalizeUrl(section.url)}">
                {section.name}
              </a>
            </div>
          </li>
        {/if}
      {/each}
      <li
        class="nav-item"
        on:mouseenter="{() => {
          navTimeout = setTimeout(() => activeSection.set('more'), timeout);
        }}"
        on:focus="{() => activeSection.set('more')}"
        on:mouseleave="{() => {
          clearTimeout(navTimeout);
          activeSection.set(null);
        }}"
        on:blur="{() => {
          clearTimeout(navTimeout);
          activeSection.set(null);
        }}"
        on:click="{() => {
          if ($activeSection === 'more') {
            clearTimeout(navTimeout);
            activeSection.set(null);
          }
        }}"
      >
        <div
          class="nav-button more link"
          class:open="{$activeSection === 'more'}"
        >
          <button class="button">
            <span>More <DownArrow rotate="{$activeSection === 'more'}" /></span>
          </button>
        </div>
        {#if $activeSection === 'more'}
          <MoreDropdown sections="{hiddenSections}" />
        {/if}
      </li>
    </ul>
  </nav>
</div>

<style>@charset "UTF-8";
/*
Several components utilize z-index, the CSS property that helps control layout by providing a third axis to arrange content. We utilize a default z-index scale that’s been designed to properly layer navigation, tooltips and popovers, modals, and more.
These higher values start at an arbitrary number, high and specific enough to ideally avoid conflicts. We need a standard set of these across our layered components—tooltips, popovers, navbars, dropdowns, modals—so we can be reasonably consistent in the behaviors.
To handle overlapping borders within components (e.g., buttons and inputs in input groups), we use low single digit z-index values of 1, 2, and 3 for default, hover, and active states. On hover/focus/active, we bring a particular element to the forefront with a higher z-index value to show their border over the sibling elements.
*/
.nav-bar {
  margin-left: auto;
}
@media (max-width: 745px) {
  .nav-bar {
    display: none;
  }
}

.nav-list {
  list-style: none;
  margin: 0;
  padding: 0;
}

.nav-item {
  display: inline-flex;
  padding: 0 10px;
  font-family: "Knowledge", "Source Sans Pro", Arial, sans-serif;
  font-weight: 500;
  font-size: 16px;
}
.nav-item .nav-button {
  position: relative;
  height: 64px;
  display: flex;
  align-items: center;
  cursor: pointer;
}
.nav-item .nav-button a,
.nav-item .nav-button span {
  color: var(--nav-primary, #404040);
}
.nav-item .nav-button a:hover, .nav-item .nav-button a:active,
.nav-item .nav-button span:hover,
.nav-item .nav-button span:active {
  text-decoration: none;
}
@media (max-width: 745px) {
  .nav-item .nav-button {
    height: 56px;
  }
}
.nav-item .nav-button.open:after {
  content: "";
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  display: block;
  height: 4px;
  background: var(--nav-accent, #fa6400);
  opacity: 1 !important;
}
.nav-item .link {
  position: relative;
  line-height: 64px;
}
.nav-item .link:hover:after {
  content: "";
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  display: block;
  height: 4px;
  background: var(--nav-accent, #fa6400);
}

.button {
  margin: 0;
  padding: 0;
  border: none;
  background-color: unset;
  -webkit-appearance: none;
     -moz-appearance: none;
          appearance: none;
  cursor: pointer;
  font-family: "Knowledge", "Source Sans Pro", Arial, sans-serif;
  font-weight: 500;
  font-size: 16px;
  color: var(--nav-primary, #404040);
}
.button:not(.focused) {
  outline: none;
}

.category {
  display: none;
}
@media (max-width: 1023px) {
  .category:nth-child(-n+4) {
    display: inline-flex;
  }
}
@media (min-width: 1024px) {
  .category:nth-child(-n+5) {
    display: inline-flex;
  }
}
@media (min-width: 1300px) {
  .category:nth-child(-n+7) {
    display: inline-flex;
  }
}</style>
